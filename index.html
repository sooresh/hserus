<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>hserus</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
body{margin:0;background:#07121a;color:#e6f3f6;font-family:Arial;padding:16px}
h1{font-size:18px;margin:0}
.controls{display:flex;gap:10px;align-items:center;margin-top:8px}
button{padding:8px 14px;border:none;border-radius:6px;background:#7be3c7;color:#022;cursor:pointer}
button:disabled{opacity:.5}
.small{font-size:13px;color:#9fb6c7}
#bar{height:10px;background:#122;border-radius:6px;overflow:hidden;margin-top:12px}
#fill{height:100%;width:0%;background:linear-gradient(90deg,#7be3c7,#2bd18a)}
table{width:100%;border-collapse:collapse;margin-top:14px;background:#0b2230}
th,td{padding:9px;border-bottom:1px solid #123;text-align:right}
th{cursor:pointer;color:#9fb6c7}
td.symbol{text-align:left;color:#7bdfff;font-weight:bold}
.green{color:#7be3c7}
.red{color:#ff6b6b}
</style>
</head>
<body>

<h1>hserus</h1>
<div class="controls">
  <button id="refresh">Refresh</button>
  <div id="status" class="small">Idle</div>
</div>

<div id="bar"><div id="fill"></div></div>

<table id="tbl">
<thead>
<tr>
  <th>Symbol</th>
  <th>Close%</th>
  <th>Vol%</th>
  <th>Same4h</th>
</tr>
</thead>
<tbody id="body">
<tr><td colspan="4" class="small">Click Refresh</td></tr>
</tbody>
</table>

<script>
const BASE = 'https://fapi.binance.com';
const BATCH = 5;
const MAX = 250;

const EXCLUDE = new Set([
"BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT","ADAUSDT","DOGEUSDT","AVAXUSDT",
"DOTUSDT","TRXUSDT","LINKUSDT","LTCUSDT","BCHUSDT","ATOMUSDT","FILUSDT","APTUSDT","SUIUSDT"
]);

const tbody = document.getElementById('body');
const fill = document.getElementById('fill');
const status = document.getElementById('status');
const btn = document.getElementById('refresh');

const pct = (a,b)=>((a-b)/b)*100;
const color = (o,c)=>c>o?'green':c<o?'red':'doji';

async function j(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error(r.status);
  return r.json();
}

async function symbols(){
  const [ei,t] = await Promise.all([
    j(BASE+'/exchangeInfo'),
    j(BASE+'/ticker/24hr')
  ]);
  const perp = new Set(ei.symbols
    .filter(s=>s.contractType==='PERPETUAL' && s.symbol.endsWith('USDT'))
    .map(s=>s.symbol));

  return t
    .filter(x=>perp.has(x.symbol) && !EXCLUDE.has(x.symbol))
    .map(x=>({s:x.symbol,score:Math.abs(x.priceChangePercent)*x.quoteVolume}))
    .sort((a,b)=>b.score-a.score)
    .slice(0,MAX)
    .map(x=>x.s);
}

async function klines(sym,tf,lim){
  return j(`${BASE}/klines?symbol=${sym}&interval=${tf}&limit=${lim}`);
}

async function scan(){
  btn.disabled=true;
  tbody.innerHTML='';
  fill.style.width='0%';
  status.textContent='Fetching symbolsâ€¦';

  const syms = await symbols();
  let done=0;

  for(let i=0;i<syms.length;i+=BATCH){
    const batch = syms.slice(i,i+BATCH);

    const res = await Promise.all(batch.map(async s=>{
      try{
        const [k1,k4] = await Promise.all([
          klines(s,'1h',2),
          klines(s,'4h',3)
        ]);

        const c1=k1[1], p1=k1[0];
        const c4=k4[1], p4=k4[0];

        if(+c1[5] <= +p1[5]) return;
        if(+p4[5] <= +k4[0][5]) return;

        if(color(c1[1],c1[4]) !== color(p4[1],p4[4])) return;

        return {
          s,
          cp:pct(+c1[4],+c1[1]),
          vp:pct(+c1[5],+p1[5]),
          same: color(c4[1],c4[4])===color(p4[1],p4[4])?'Yes':'No'
        };
      }catch{return;}
    }));

    res.filter(Boolean).forEach(o=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td class="symbol">${o.s}</td>
        <td class="${o.cp>=0?'green':'red'}">${o.cp.toFixed(2)}%</td>
        <td>${o.vp.toFixed(2)}%</td>
        <td>${o.same}</td>`;
      tbody.appendChild(tr);
    });

    done+=batch.length;
    fill.style.width=(done/syms.length*100)+'%';
    status.textContent=`Scanning ${done}/${syms.length}`;
    await new Promise(r=>setTimeout(r,120));
  }

  status.textContent='Scan complete';
  btn.disabled=false;
}

btn.onclick=scan;

/* sorting */
document.querySelectorAll('th').forEach((th,i)=>{
  th.onclick=()=>{
    const rows=[...tbody.rows];
    const asc=th.asc=!th.asc;
    rows.sort((a,b)=>{
      const x=a.cells[i].innerText.replace('%','');
      const y=b.cells[i].innerText.replace('%','');
      return asc?x-y:y-x;
    });
    rows.forEach(r=>tbody.appendChild(r));
  };
});
</script>
</body>
</html>
