<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>hserus</title>
<style>
:root{--bg:#08131d;--card:#0f212e;--muted:#8fa2b7;--accent:#7be3c7;--danger:#ff9a9a}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(#020c14,#061520);color:#e6f3f6;padding:14px}
header{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:10px}
h1{margin:0;font-size:18px}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
select,button{padding:6px 10px;border-radius:6px;border:1px solid #12333d;background:var(--card);color:inherit}
button{cursor:pointer}
#status{font-size:13px;color:var(--muted)}
table{width:100%;border-collapse:collapse;margin-top:12px;font-size:13px}
th,td{text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,0.06)}
th{color:var(--muted);font-size:12px;cursor:pointer}
tr.match{background:rgba(11,36,48,0.4)}
.green{color:#7be3c7}
.red{color:#ff9a9a}
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div>
    <h1>hserus</h1>
    <div class="small">hserus</div>
  </div>
  <div class="controls">
    <label class="small">Sort:
      <select id="sortSelect">
        <option value="closePct_desc">Close % ↓</option>
        <option value="closePct_asc">Close % ↑</option>
        <option value="currVolPct_desc">Curr Vol % ↓</option>
        <option value="currVolPct_asc">Curr Vol % ↑</option>
        <option value="prevVolPct_desc">Prev Vol % ↓</option>
        <option value="prevVolPct_asc">Prev Vol % ↑</option>
        <option value="symbol_asc">Symbol A→Z</option>
        <option value="symbol_desc">Symbol Z→A</option>
      </select>
    </label>
    <button id="refreshBtn">Refresh</button>
    <div id="status">Idle</div>
  </div>
</header>

<main>
  <table>
    <thead>
      <tr>
        <th>Symbol</th>
        <th>Close %</th>
        <th>Curr Vol %</th>
        <th>Prev Vol %</th>
      </tr>
    </thead>
    <tbody id="resultsBody">
      <tr><td colspan="4" class="small">Click Refresh to start scanning...</td></tr>
    </tbody>
  </table>
</main>

<script>
const LIMIT = 3;  // need last 3 candles
const INTERVAL = '1h';
const MAX_SYMBOLS = 200;
const EXCLUDE = ["BTCUSDT","ETHUSDT","SOLUSDT","BNBUSDT","XRPUSDT","ADAUSDT","DOGEUSDT","TONUSDT","AVAXUSDT","DOTUSDT","TRXUSDT","SHIBUSDT","LINKUSDT","NEARUSDT","MATICUSDT","LTCUSDT","UNIUSDT","BCHUSDT","ICPUSDT","LEOUSDT"];
const PAUSE_MS = 120;

const resultsBody = document.getElementById('resultsBody');
const statusEl = document.getElementById('status');
const sortSelect = document.getElementById('sortSelect');
const refreshBtn = document.getElementById('refreshBtn');

let results = [];

function pctChange(prev, curr) {
  if (!prev) return NaN;
  return ((curr - prev) / prev) * 100;
}
function formatPct(v) {
  if (isNaN(v)) return '—';
  return v.toFixed(2) + '%';
}
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

async function fetchPerpSymbols() {
  const url = 'https://fapi.binance.com/fapi/v1/exchangeInfo';
  const r = await fetch(url);
  const data = await r.json();
  return data.symbols
    .filter(s => s.contractType === 'PERPETUAL' && s.symbol.endsWith('USDT') && !EXCLUDE.includes(s.symbol))
    .map(s => s.symbol);
}

async function fetchTopSymbols(limit=MAX_SYMBOLS) {
  const [tickRes, perpSymbols] = await Promise.all([
    fetch('https://fapi.binance.com/fapi/v1/ticker/24hr'),
    fetchPerpSymbols()
  ]);
  const tick = await tickRes.json();
  return tick
    .filter(t => perpSymbols.includes(t.symbol))
    .sort((a,b) => Math.abs(parseFloat(b.priceChangePercent)) - Math.abs(parseFloat(a.priceChangePercent)))
    .slice(0, limit)
    .map(t => t.symbol);
}

async function fetchKlines(symbol, interval, limit) {
  const url = `https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
  const r = await fetch(url);
  const raw = await r.json();
  return raw.map(c => ({open:+c[1], close:+c[4], volume:+c[5]}));
}

function checkSymbol(symbol, klines) {
  if (klines.length < 3) return null;
  const prev2 = klines[0], prev = klines[1], last = klines[2];
  // (1) Color of last 2 candles differ
  const lastGreen = last.close > last.open;
  const prevGreen = prev.close > prev.open;
  if (lastGreen === prevGreen) return null;
  // (2) Volumes: last > prev > prev2
  if (!(last.volume > prev.volume && prev.volume > prev2.volume)) return null;

  return {
    symbol,
    closePct: pctChange(prev.close, last.close),
    currVolPct: pctChange(prev.volume, last.volume),
    prevVolPct: pctChange(prev2.volume, prev.volume)
  };
}

function appendRow(obj) {
  const tr = document.createElement('tr');
  tr.className = 'match';
  tr.innerHTML = `
    <td><strong>${obj.symbol}</strong></td>
    <td>${formatPct(obj.closePct)}</td>
    <td>${formatPct(obj.currVolPct)}</td>
    <td>${formatPct(obj.prevVolPct)}</td>
  `;
  resultsBody.appendChild(tr);
}

function sortResults(list, sortKey) {
  const [key, order] = sortKey.split('_');
  const m = (order==='asc'?1:-1);
  return list.sort((a,b)=>{
    if(a[key]==null) return 1;
    if(b[key]==null) return -1;
    if(typeof a[key]==="string") return a[key].localeCompare(b[key])*m;
    return (a[key]-b[key])*m;
  });
}

function renderTable() {
  const sorted = sortResults([...results], sortSelect.value);
  resultsBody.innerHTML = '';
  if(sorted.length===0){
    resultsBody.innerHTML = '<tr><td colspan="4" class="small">No matches found.</td></tr>';
    return;
  }
  sorted.forEach(r=>appendRow(r));
}

async function runScan(){
  results=[];
  resultsBody.innerHTML='<tr><td colspan="4" class="small">Scanning...</td></tr>';
  statusEl.textContent="Fetching symbols...";
  const symbols=await fetchTopSymbols(MAX_SYMBOLS);
  let i=0;
  for(const sym of symbols){
    i++;
    statusEl.textContent=`Scanning ${i}/${symbols.length}: ${sym}`;
    try{
      const klines=await fetchKlines(sym,INTERVAL,LIMIT);
      const res=checkSymbol(sym,klines);
      if(res){results.push(res); appendRow(res);}
    }catch(e){console.warn("error",sym,e);}
    await sleep(PAUSE_MS);
  }
  statusEl.textContent=`Done — ${results.length} matches`;
  renderTable();
}

refreshBtn.addEventListener('click',()=>{
  refreshBtn.disabled=true;
  runScan().finally(()=>refreshBtn.disabled=false);
});
sortSelect.addEventListener('change',renderTable);
window.addEventListener('load',()=>refreshBtn.click());
</script>
</body>
</html>

